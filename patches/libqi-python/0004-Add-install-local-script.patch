From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Simon Belgers <123083599+SBelgers@users.noreply.github.com>
Date: Wed, 18 Feb 2026 11:37:00 +0100
Subject: [PATCH 4/4] Add install_local.py helper script

Script to install the pre-built qi Python package into the active
environment's site-packages for local development and testing.

It copies:
  - Python source files from qi/
  - Generated files (_version.py, native.py) and qi_python.pyd from
    the build output directory
  - All required DLLs (libqi, Boost, OpenSSL) discovered from the
    libqi build output and Conan's CONAN_RUNTIME_LIB_DIRS

Handles the double-nested build directory layout that can occur with
CMake presets (build/release/build/release/).
---
 install_local.py | 126 +++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 126 insertions(+)
 create mode 100644 install_local.py

diff --git a/install_local.py b/install_local.py
new file mode 100644
index 0000000..63f4cfd
--- /dev/null
+++ b/install_local.py
@@ -0,0 +1,126 @@
+"""
+Script to install the pre-built qi package into the active Python environment
+for local development and testing.
+
+Usage:
+    python install_local.py
+
+This copies the built qi_python.pyd, Python files, and required DLLs into
+the active environment's site-packages/qi directory.
+
+DLL paths are read from Conan's generated toolchain file (CONAN_RUNTIME_LIB_DIRS).
+"""
+
+import os
+import re
+import sys
+import shutil
+import sysconfig
+
+
+def find_conan_runtime_lib_dirs(toolchain_path):
+    """Parse CONAN_RUNTIME_LIB_DIRS from the Conan toolchain cmake file."""
+    with open(toolchain_path, "r") as f:
+        content = f.read()
+    match = re.search(
+        r'set\(CONAN_RUNTIME_LIB_DIRS\s+"([^)]+)"\s*\)', content
+    )
+    if not match:
+        return []
+    raw = match.group(1)
+    # Split on '" "' pattern
+    dirs = [d.strip().strip('"') for d in raw.split('" "')]
+    return dirs
+
+
+def main():
+    project_dir = os.path.dirname(os.path.abspath(__file__))
+    build_dir = os.path.join(project_dir, "build", "release")
+    qi_source_dir = os.path.join(project_dir, "qi")
+    qi_build_dir = os.path.join(build_dir, "qi")
+
+    # Handle double-nested build directory (cmake preset quirk)
+    qi_build_dir_nested = os.path.join(build_dir, "build", "release", "qi")
+    if not os.path.exists(os.path.join(qi_build_dir, "qi_python.pyd")) and \
+       os.path.exists(os.path.join(qi_build_dir_nested, "qi_python.pyd")):
+        qi_build_dir = qi_build_dir_nested
+        print(f"  Using nested build dir: {qi_build_dir}")
+
+    # Find generators dir (may also be nested)
+    toolchain_file = os.path.join(build_dir, "generators", "conan_toolchain.cmake")
+    if not os.path.isfile(toolchain_file):
+        toolchain_file = os.path.join(build_dir, "build", "release", "generators", "conan_toolchain.cmake")
+
+    site_packages = sysconfig.get_path("purelib")
+    qi_install_dir = os.path.join(site_packages, "qi")
+
+    print(f"Installing qi to: {qi_install_dir}")
+    os.makedirs(qi_install_dir, exist_ok=True)
+
+    # 1. Copy Python source files
+    py_files = [
+        "__init__.py", "logging.py", "path.py", "translator.py",
+        "_binder.py", "_type.py",
+    ]
+    for f in py_files:
+        src = os.path.join(qi_source_dir, f)
+        if os.path.exists(src):
+            shutil.copy2(src, qi_install_dir)
+            print(f"  Copied {f}")
+
+    # 2. Copy generated Python files
+    for f in ["_version.py", "native.py"]:
+        src = os.path.join(qi_build_dir, f)
+        if os.path.exists(src):
+            shutil.copy2(src, qi_install_dir)
+            print(f"  Copied {f} (generated)")
+
+    # 3. Copy the .pyd file
+    pyd_src = os.path.join(qi_build_dir, "qi_python.pyd")
+    if os.path.exists(pyd_src):
+        shutil.copy2(pyd_src, qi_install_dir)
+        print(f"  Copied qi_python.pyd")
+    else:
+        print(f"  WARNING: qi_python.pyd not found at {pyd_src}")
+        sys.exit(1)
+
+    # 4. Collect all DLL directories
+    dll_dirs = []
+
+    # libqi build output
+    libqi_bin = os.path.join(project_dir, "..", "libqi", "build", "release", "sdk", "bin")
+    if os.path.isdir(libqi_bin):
+        dll_dirs.append(libqi_bin)
+
+    # libqi-python build output
+    local_sdk_bin = os.path.join(build_dir, "sdk", "bin")
+    local_sdk_bin_nested = os.path.join(build_dir, "build", "release", "sdk", "bin")
+    if os.path.isdir(local_sdk_bin):
+        dll_dirs.append(local_sdk_bin)
+    if os.path.isdir(local_sdk_bin_nested):
+        dll_dirs.append(local_sdk_bin_nested)
+
+    # Conan runtime lib dirs (Boost, OpenSSL, etc.)
+    if os.path.isfile(toolchain_file):
+        conan_dirs = find_conan_runtime_lib_dirs(toolchain_file)
+        for d in conan_dirs:
+            resolved = os.path.normpath(d) if os.path.isabs(d) else os.path.normpath(os.path.join(build_dir, d))
+            if os.path.isdir(resolved):
+                dll_dirs.append(resolved)
+
+    # 5. Copy all DLLs
+    copied_dlls = set()
+    for dll_dir in dll_dirs:
+        for f in os.listdir(dll_dir):
+            if f.lower().endswith(".dll") and f not in copied_dlls:
+                shutil.copy2(os.path.join(dll_dir, f), qi_install_dir)
+                print(f"  Copied DLL: {f}")
+                copied_dlls.add(f)
+
+    print(f"\nInstalled {len(py_files) + 2} Python files, 1 .pyd, and {len(copied_dlls)} DLLs.")
+    print(f'Test with: python -c "import qi; print(\'OK\')"')
+
+
+if __name__ == "__main__":
+    main()
-- 
2.38.1.windows.1

