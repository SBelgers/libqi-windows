From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Simon Belgers <123083599+SBelgers@users.noreply.github.com>
Date: Wed, 18 Feb 2026 11:24:21 +0100
Subject: [PATCH 3/4] Fix Python 3.13+ and MSVC compatibility

- qipython/common.hpp: Use the public Py_IsFinalizing() API on
  Python >= 3.13, where the private _Py_IsFinalizing() was removed.
- src/pytypes.cpp: Use Py_ssize_t instead of ssize_t, which is not
  defined on MSVC.
---
 qipython/common.hpp | 7 +++++--
 src/pytypes.cpp     | 2 +-
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/qipython/common.hpp b/qipython/common.hpp
index 3335f66..3edf3a9 100644
--- a/qipython/common.hpp
+++ b/qipython/common.hpp
@@ -116,8 +116,11 @@ boost::optional<T> extractKeywordArg(pybind11::dict kwargs,
 /// finalizing or not.
 inline boost::optional<bool> interpreterIsFinalizing()
 {
-// `_Py_IsFinalizing` is only available on CPython 3.7+
-#if PY_VERSION_HEX >= 0x03070000
+// `Py_IsFinalizing` is the public API (available since 3.13).
+// `_Py_IsFinalizing` was the private API (available in CPython 3.7 to 3.12).
+#if PY_VERSION_HEX >= 0x030D0000
+  return boost::make_optional(Py_IsFinalizing() != 0);
+#elif PY_VERSION_HEX >= 0x03070000
   return boost::make_optional(_Py_IsFinalizing() != 0);
 #else
   // There is no way of knowing on older versions.
diff --git a/src/pytypes.cpp b/src/pytypes.cpp
index 41795d3..4b18a8f 100644
--- a/src/pytypes.cpp
+++ b/src/pytypes.cpp
@@ -91,7 +91,7 @@ struct ValueToPyObject
     // try to create a Python `bytes` instead.
     const auto toUnicode = [&] {
       const auto obj = ::py::reinterpret_steal<::py::str>(
-        PyUnicode_FromStringAndSize(data, static_cast<ssize_t>(len)));
+        PyUnicode_FromStringAndSize(data, static_cast<Py_ssize_t>(len)));
       // When it fails, the conversion may set a Python error. We need to handle
       // it by throwing `error_already_set`.
       if (!obj)
-- 
2.38.1.windows.1

